name: Maestro E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest # Maestro requires macOS or Linux with ADB
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        echo "$HOME/.maestro/bin" >> $GITHUB_PATH
        
    - name: Create .env file from secrets
      run: |
        cat > .env << EOF
        NORDVPN_USERNAME=${{ secrets.NORDVPN_USERNAME }}
        NORDVPN_PASSWORD=${{ secrets.NORDVPN_PASSWORD }}
        TEST_VPN_HOSTNAME=${TEST_VPN_HOSTNAME:-uk1234.nordvpn.com}
        TEST_VPN_REGION=${TEST_VPN_REGION:-UK}
        TEST_APP_PACKAGE=${TEST_APP_PACKAGE:-com.android.chrome}
        EOF
      env:
        TEST_VPN_HOSTNAME: ${{ secrets.TEST_VPN_HOSTNAME || 'uk1234.nordvpn.com' }}
        TEST_VPN_REGION: ${{ secrets.TEST_VPN_REGION || 'UK' }}
        TEST_APP_PACKAGE: ${{ secrets.TEST_APP_PACKAGE || 'com.android.chrome' }}
        
    - name: Build APK
      run: ./gradlew assembleDebug
      
    - name: Start Android Emulator and Run Tests
      uses: reactivecircus/android-emulator-runner@v2
      env:
        NORDVPN_USERNAME: ${{ secrets.NORDVPN_USERNAME }}
        NORDVPN_PASSWORD: ${{ secrets.NORDVPN_PASSWORD }}
        TEST_VPN_HOSTNAME: ${{ secrets.TEST_VPN_HOSTNAME || 'uk1234.nordvpn.com' }}
        TEST_VPN_REGION: ${{ secrets.TEST_VPN_REGION || 'UK' }}
        TEST_APP_PACKAGE: ${{ secrets.TEST_APP_PACKAGE || 'com.android.chrome' }}
      with:
        api-level: 34
        script: |
          # Install APK
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          
          # Run Maestro tests with environment variables
          maestro test .maestro/
          
          # Export test results
          maestro report .maestro/ --output test-results.html

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: maestro-test-results
        path: |
          test-results.html
          .maestro/tests/

