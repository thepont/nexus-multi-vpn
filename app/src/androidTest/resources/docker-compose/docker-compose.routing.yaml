version: '3.8'

services:
  # UK VPN Server (subnet 10.1.0.0/24)
  vpn-server-uk:
    image: kylemanna/openvpn:latest
    container_name: vpn-server-uk
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "1194:1194/udp"
    volumes:
      - ../../../../openvpn-uk:/etc/openvpn
    networks:
      vpn-uk:
        ipv4_address: 10.1.0.1
    command: >
      sh -c "
        if [ ! -f /etc/openvpn/pki/ca.crt ]; then
          echo '⚠️  PKI not found - generating...'
          ovpn_genconfig -u udp://vpn-server-uk -N -d -s 10.1.0.0/24
          EASYRSA_BATCH=1 ovpn_initpki nopass
        fi
        openvpn --config /etc/openvpn/server.conf
      "
    environment:
      - OVPN_SERVER_URL=udp://vpn-server-uk:1194

  # FR VPN Server (subnet 10.2.0.0/24)
  vpn-server-fr:
    image: kylemanna/openvpn:latest
    container_name: vpn-server-fr
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "1195:1194/udp"
    volumes:
      - ../../../../openvpn-fr:/etc/openvpn
    networks:
      vpn-fr:
        ipv4_address: 10.2.0.1
    command: >
      sh -c "
        if [ ! -f /etc/openvpn/pki/ca.crt ]; then
          echo '⚠️  PKI not found - generating...'
          ovpn_genconfig -u udp://vpn-server-fr -N -d -s 10.2.0.0/24
          EASYRSA_BATCH=1 ovpn_initpki nopass
        fi
        openvpn --config /etc/openvpn/server.conf
      "
    environment:
      - OVPN_SERVER_URL=udp://vpn-server-fr:1194

  # HTTP Server on UK VPN Network
  http-server-uk:
    image: nginx:alpine
    container_name: http-server-uk
    ports:
      - "18080:80"
    networks:
      vpn-uk:
        ipv4_address: 10.1.0.2
    volumes:
      - ../../../../http-uk:/usr/share/nginx/html:ro
    command: nginx -g 'daemon off;'

  # HTTP Server on FR VPN Network
  http-server-fr:
    image: nginx:alpine
    container_name: http-server-fr
    ports:
      - "18081:80"
    networks:
      vpn-fr:
        ipv4_address: 10.2.0.2
    volumes:
      - ../../../../http-fr:/usr/share/nginx/html:ro
    command: nginx -g 'daemon off;'

networks:
  vpn-uk:
    driver: bridge
    ipam:
      config:
        - subnet: 10.1.0.0/24
  vpn-fr:
    driver: bridge
    ipam:
      config:
        - subnet: 10.2.0.0/24

