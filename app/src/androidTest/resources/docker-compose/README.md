# Docker Compose Test Environments

This directory contains Docker Compose configurations for local E2E testing.

## Setup

### Prerequisites
- Docker and Docker Compose installed
- `/dev/net/tun` device available (for OpenVPN)

### Starting an Environment

1. Navigate to this directory:
   ```bash
   cd app/src/androidTest/resources/docker-compose
   ```

2. Start the environment:
   ```bash
   docker-compose -f docker-compose.dns-domain.yaml up -d
   ```

3. Verify services are running:
   ```bash
   docker-compose -f docker-compose.dns-domain.yaml ps
   ```

4. Check logs:
   ```bash
   docker-compose -f docker-compose.dns-domain.yaml logs -f
   ```

### Stopping an Environment

```bash
docker-compose -f docker-compose.dns-domain.yaml down
```

## Available Environments

### docker-compose.dns-domain.yaml
DNS domain name resolution test environment:
- **DNS Server** (dnsmasq): Port 5353, resolves `test.example.com` -> `10.4.0.10`
- **OpenVPN Server**: Port 1199, pushes DNS server `10.4.0.2` via DHCP
- **HTTP Server**: Port 8085, accessible at `test.example.com`

**Purpose**: Tests DNS resolution through VPN using domain names (not just IP addresses).

**Test Domain**: `test.example.com` resolves to `10.4.0.10`

**OpenVPN Configuration**: 
- Server config: `openvpn-dns-domain/server.conf`
- Pushes DNS via: `push "dhcp-option DNS 10.4.0.2"`
- PKI certificates are auto-generated by the Docker container on first run

### docker-compose.dns.yaml
DNS resolution test environment (hostname-based).

### docker-compose.routing.yaml
Multi-tunnel routing test environment.

### docker-compose.conflict.yaml
Subnet conflict handling test environment.

## OpenVPN Server Configuration

OpenVPN servers need to push DNS via DHCP options. The server configuration should include:

```
push "dhcp-option DNS 10.4.0.2"
```

This is configured in:
- `openvpn-dns-domain/server.conf` (for DNS domain test)
- `openvpn-dns/server.conf` (for DNS test)

## DNS Server Configuration

The DNS server (dnsmasq) is configured via `dnsmasq-domain.conf`:
- Resolves `test.example.com` to `10.4.0.10`
- Forwards other queries to `8.8.8.8` and `8.8.4.4`

## Network Configuration

All services are on the `10.4.0.0/24` subnet:
- `10.4.0.1`: OpenVPN server
- `10.4.0.2`: DNS server
- `10.4.0.10`: HTTP server (test.example.com)

## PKI Certificate Generation

OpenVPN servers automatically generate PKI certificates on first run if they don't exist:
- The `kylemanna/openvpn` image includes `ovpn_genconfig` and `ovpn_initpki`
- Certificates are stored in the volume-mounted directory (e.g., `openvpn-dns-domain/pki/`)
- Client certificates can be generated for testing if needed
