version: '3.8'

services:
  # UK VPN Server (subnet 10.8.0.0/24)
  vpn-server-uk:
    image: kylemanna/openvpn:latest
    container_name: vpn-server-uk-conflict
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "1197:1194/udp"
    volumes:
      - ../../../../openvpn-uk-conflict:/etc/openvpn
    networks:
      vpn-conflict:
        ipv4_address: 10.8.0.1
    command: >
      sh -c "
        if [ ! -f /etc/openvpn/pki/ca.crt ]; then
          echo '⚠️  PKI not found - generating...'
          ovpn_genconfig -u udp://vpn-server-uk-conflict -N -d -s 10.8.0.0/24
          EASYRSA_BATCH=1 ovpn_initpki nopass
        fi
        openvpn --config /etc/openvpn/server.conf
      "
    environment:
      - OVPN_SERVER_URL=udp://vpn-server-uk-conflict:1194

  # FR VPN Server (SAME subnet 10.8.0.0/24 - CONFLICT!)
  vpn-server-fr:
    image: kylemanna/openvpn:latest
    container_name: vpn-server-fr-conflict
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "1198:1194/udp"
    volumes:
      - ../../../../openvpn-fr-conflict:/etc/openvpn
    networks:
      vpn-conflict:
        ipv4_address: 10.8.0.2
    command: >
      sh -c "
        if [ ! -f /etc/openvpn/pki/ca.crt ]; then
          echo '⚠️  PKI not found - generating...'
          ovpn_genconfig -u udp://vpn-server-fr-conflict -N -d -s 10.8.0.0/24
          EASYRSA_BATCH=1 ovpn_initpki nopass
        fi
        openvpn --config /etc/openvpn/server.conf
      "
    environment:
      - OVPN_SERVER_URL=udp://vpn-server-fr-conflict:1194

  # HTTP Server on UK side (10.8.0.3)
  http-server-uk:
    image: nginx:alpine
    container_name: http-server-uk-conflict
    ports:
      - "8083:80"
    networks:
      vpn-conflict:
        ipv4_address: 10.8.0.3
    volumes:
      - ../../../../http-uk-conflict:/usr/share/nginx/html:ro
    command: nginx -g 'daemon off;'

  # HTTP Server on FR side (10.8.0.4)
  http-server-fr:
    image: nginx:alpine
    container_name: http-server-fr-conflict
    ports:
      - "8084:80"
    networks:
      vpn-conflict:
        ipv4_address: 10.8.0.4
    volumes:
      - ../../../../http-fr-conflict:/usr/share/nginx/html:ro
    command: nginx -g 'daemon off;'

networks:
  vpn-conflict:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.0.0/24

